

test_that("bitstring roundtrip works", {
  
  raw_vec <- as.raw(1:16)
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # as 64 bits
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  res <- raw_to_bitstrings(raw_vec, 8)
  expect_length(res, 2)
  res <- bitstrings_to_raw(res)
  expect_identical(res, raw_vec)
  
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # As 32 bits
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  res <- raw_to_bitstrings(raw_vec, 4)
  expect_length(res, 4)
  res <- bitstrings_to_raw(res)
  expect_identical(res, raw_vec)
  
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # As 16 bits
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  res <- raw_to_bitstrings(raw_vec, 2)
  expect_length(res, 8)
  res <- bitstrings_to_raw(res)
  expect_identical(res, raw_vec)
  
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # Twiddle the endianness
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  raw_vec <- as.raw(1:2)
  res <- raw_to_bitstrings(raw_vec, 2, endian = 'big')
  expect_length(res, 1)
  res <- bitstrings_to_raw(res, endian = 'big')
  expect_identical(res, raw_vec)
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # Twiddle the endianness
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  raw_vec <- as.raw(1:2)
  res <- raw_to_bitstrings(raw_vec, 2, endian = 'big')
  expect_length(res, 1)
  res <- bitstrings_to_raw(res, endian = 'little')
  expect_identical(res, rev(raw_vec))
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # Twiddle the endianness
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  raw_vec <- as.raw(1:2)
  res <- raw_to_bitstrings(raw_vec, 2, endian = 'little')
  expect_length(res, 1)
  res <- bitstrings_to_raw(res, endian = 'big')
  expect_identical(res, rev(raw_vec))
})


test_that("read/write uint64 as bitstring", {
  input <- 1:15
  N <- length(input)
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # Write data
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  con <- rawConnection(raw(), open = "w")
  write_uint64(con, input)  
  dat <- rawConnectionValue(con)  
  close(con)
  dat
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # Read it back
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  con <- rawConnection(dat, open = 'r')
  output <- read_uint64(con, N, promote = 'bitstring')
  close(con)
  
  expect_identical(
    output, 
    c("0000000000000000000000000000000000000000000000000000000000000001", 
      "0000000000000000000000000000000000000000000000000000000000000010", 
      "0000000000000000000000000000000000000000000000000000000000000011", 
      "0000000000000000000000000000000000000000000000000000000000000100", 
      "0000000000000000000000000000000000000000000000000000000000000101", 
      "0000000000000000000000000000000000000000000000000000000000000110", 
      "0000000000000000000000000000000000000000000000000000000000000111", 
      "0000000000000000000000000000000000000000000000000000000000001000", 
      "0000000000000000000000000000000000000000000000000000000000001001", 
      "0000000000000000000000000000000000000000000000000000000000001010", 
      "0000000000000000000000000000000000000000000000000000000000001011", 
      "0000000000000000000000000000000000000000000000000000000000001100", 
      "0000000000000000000000000000000000000000000000000000000000001101", 
      "0000000000000000000000000000000000000000000000000000000000001110", 
      "0000000000000000000000000000000000000000000000000000000000001111"
    )
  )
})





test_that("read/write uint32 as bitstring", {
  input <- 1:15
  N <- length(input)
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # Write data
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  con <- rawConnection(raw(), open = "w")
  write_uint32(con, input)  
  dat <- rawConnectionValue(con)  
  close(con)
  dat
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # Read it back
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  con <- rawConnection(dat, open = 'r')
  output <- read_uint32(con, N, promote = 'bitstring')
  close(con)
  
  expect_identical(
    output, 
    c("00000000000000000000000000000001", "00000000000000000000000000000010", 
      "00000000000000000000000000000011", "00000000000000000000000000000100", 
      "00000000000000000000000000000101", "00000000000000000000000000000110", 
      "00000000000000000000000000000111", "00000000000000000000000000001000", 
      "00000000000000000000000000001001", "00000000000000000000000000001010", 
      "00000000000000000000000000001011", "00000000000000000000000000001100", 
      "00000000000000000000000000001101", "00000000000000000000000000001110", 
      "00000000000000000000000000001111")
  )
})


